tests:
  - script: |
      # The following example exercises permissions granted by the cluster-monitoring-view Cluster Role.
      # The binding commands are supposed to run by a user with the necessary privileges.
      oc create namespace test-prometheus-web-cluster-monitoring-view
      oc create serviceaccount prom-client --namespace=test-prometheus-web-cluster-monitoring-view
      # The binding is done to a Service Account, but it can also be applied to any other user.
      oc create rolebinding test-prometheus-web-cluster-monitoring-view \
        --namespace=openshift-monitoring \
        --clusterrole=cluster-monitoring-view \
        --serviceaccount=test-prometheus-web-cluster-monitoring-view:prom-client
      # The token can then be used to access the endpoints.
      TOKEN=$(oc create token prom-client --namespace=test-prometheus-web-cluster-monitoring-view)
      ROUTE=$(oc get route prometheus-k8s --namespace=openshift-monitoring -ojsonpath={.spec.host})
      curl -k -H "Authorization: Bearer $TOKEN" "https://$ROUTE/api/v1/query?query=up"
      # The endpoints can also be accessed from within the cluster.
      curl -k -H "Authorization: Bearer $TOKEN" "https://prometheus-k8s.openshift-monitoring:9091/api/v1/query?query=up"
    tearDown: |
      oc delete rolebinding test-prometheus-web-cluster-monitoring-view --namespace=openshift-monitoring
      oc delete namespace test-prometheus-web-cluster-monitoring-view --wait=false
  - script: |
      # The following example exercises permissions granted by the cluster-monitoring-metrics-api Role.
      # The binding commands are supposed to run by a user with the necessary privileges.
      oc create namespace test-prometheus-web-cluster-monitoring-metrics-api
      oc create serviceaccount prom-client --namespace=test-prometheus-web-cluster-monitoring-metrics-api
      # The binding is done to a Service Account, but it can also be applied to any other user.
      oc create rolebinding test-prometheus-web-cluster-monitoring-metrics-api \
        --namespace=openshift-monitoring \
        --role=cluster-monitoring-metrics-api  \
        --serviceaccount=test-prometheus-web-cluster-monitoring-metrics-api:prom-client
      # The token can then be used to access the endpoints.
      TOKEN=$(oc create token prom-client --namespace=test-prometheus-web-cluster-monitoring-metrics-api)
      ROUTE=$(oc get route prometheus-k8s --namespace=openshift-monitoring -ojsonpath={.spec.host})
      curl -k -H "Authorization: Bearer $TOKEN" "https://$ROUTE/api/v1/query?query=up"
      # The endpoints can also be accessed from within the cluster.
      curl -k -H "Authorization: Bearer $TOKEN" "https://prometheus-k8s.openshift-monitoring:9091/api/v1/query?query=up"
    tearDown: |
      oc delete rolebinding test-prometheus-web-cluster-monitoring-metrics-api --namespace=openshift-monitoring
      oc delete namespace test-prometheus-web-cluster-monitoring-metrics-api --wait=false
